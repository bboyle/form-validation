<!DOCTYPE html>
<html lang="en-AU">
<head>
	<meta charset="UTF-8" />
	<title>alert tests · forces validation UI tests</title>

	<link rel="stylesheet" href="../lib/qunit-git.css" />
	<script src="../lib/qunit-git.js"></script>
	<style>
		body {
			padding: 2em;
			font-family: sans-serif;
			background: #faf7f3;
			color: #111;
		}

		#qunit-fixture {
			position: static;
		}

		.alert {
			display: block;
			font-weight: bold;
			color: red;
		}

	</style>

</head>

<body>


<div id="qunit"></div>
<div id="qunit-fixture">


	<form id="test" action="javascript:">

		<ol class="questions">

			<li>
				<label for="foo">
					<span class="label">Foo</span>
					<abbr title="(required)">*</abbr>
					<em class="alert">Must be completed</em>
				</label>
				<input type="text" name="foo" id="foo" value="" required="required" />
			</li>

			<li>
				<label for="bar">
					<span class="label">Bar</span>
					<abbr title="(required)">*</abbr>
				</label>
				<input type="text" name="bar" id="bar" value="" required="required" />
			</li>

			<li>
				<label for="email">
					<span class="label">Email</span>
					<abbr title="(required)">*</abbr>
					<em class="alert">Must be an email address</em>
				</label>
				<input type="email" name="email" id="email" value="foo" required="required" />
			</li>

			<li>
				<fieldset>
					<legend>
						<span class="label">Radio foo</span>
						<abbr title="(required)">*</abbr>
						<em class="alert">Must be completed</em>
					</legend>
					<ul class="choices">
						<li>
							<input type="radio" name="radioFoo" value="foo" id="radio-foo-foo" required="required" />
							<label for="radio-foo-foo">Foo</label>
						</li>
						<li>
							<input type="radio" name="radioFoo" value="bar" id="radio-foo-bar" />
							<label for="radio-foo-bar">Bar</label>
						</li>
					</ul>
				</fieldset>
			</li>

			<li class="group atomic">
				<fieldset id="name-group">
					<legend>
						<span class="label">Your name</span>
						<em class="alert">Must be completed</em>
					</legend>
					<ol class="questions compact">
						<li>
							<label for="name-title">
								<span class="label">Title</span>
							</label>
							<input type="text" id="name-title" name="nameTitle" size="3" />
						</li>
						<li>
							<label for="name-given">
								<span class="label">Given names</span>
								<abbr title="(required)">*</abbr>
							</label>
							<input type="text" id="name-given" name="nameGiven" size="20" required="required" />
						</li>
						<li>
							<label for="name-family">
								<span class="label">Family name</span>
								<abbr title="(required)">*</abbr>
							</label>
							<input type="text" id="name-family" name="nameFamily" size="20"  required="required" />
						</li>
					</ol>
				</fieldset>
			</li>

			<li class="atomic group">
				<fieldset id="dob">
					<legend>
						<span class="label">Date of birth</span>
						<abbr title="(required)">*</abbr>
					</legend>
					<ul class="questions">
						<li>
							<label for="dob-date">
								<span class="label">Day</span>
							</label>
							<input id="dob-date" name="dobDate" type="number" size="2" maxlength="2" required="required" placeholder="dd" />
						</li>
						<li>
							<label for="dob-month">
								<span class="label">Month</span>
							</label>
							<select id="dob-month" name="dobMonth" required="required">
								<option value="">Please select…</option>
								<option>January</option>
								<option>February</option>
								<option>March</option>
								<option>April</option>
								<option>May</option>
								<option>June</option>
								<option>July</option>
								<option>August</option>
								<option>September</option>
								<option>October</option>
								<option>November</option>
								<option>December</option>
							</select>
						</li>
						<li>
							<label for="dob-year">
								<span class="label">Year</span>
							</label>
							<input id="dob-year" name="dobYear" type="number" size="4" maxlength="4" required="required" placeholder="YYYY" />
						</li>
					</ul>
				</fieldset>
			</li>

			<li class="atomic group">
				<fieldset id="postal-address">
					<legend>
						<span class="label">Postal address</span>
					</legend>
					<ol class="questions">
						<li>
							<label for="street-address">
								<span class="label">Street address</span>
								<abbr title="(required)">*</abbr>
							</label>
							<textarea id="street-address" name="streetAddress" rows="2" cols="30" required="required"></textarea>
						</li>
						<li class="group">
							<ol class="questions compact">
								<li>
									<label for="city">
										<span class="label">Town or suburb</span>
										<abbr title="(required)">*</abbr>
									</label>
									<input id="city" name="city" size="15" required="required" />
								</li>
								<li>
									<label for="state">
										<span class="label">State</span>
										<abbr title="(required)">*</abbr>
									</label>
									<input id="state" name="state" size="15" required="required" />
								</li>
								<li>
									<label for="postcode">
										<span class="label">Postcode</span>
										<abbr title="(required)">*</abbr>
									</label>
									<input id="postcode" name="postcode" size="5" required="required" />
								</li>
							</ol>
						</li>
						<li>
							<label for="country">
								<span class="label">Country</span>
								<abbr title="(required)">*</abbr>
							</label>
							<input id="country" name="country" size="30" required="required" />
						</li>
					</ol>
				</fieldset>
			</li>

			<li class="footer">
				<ol class="submit">
					<li>
						<strong>
							<input type="submit" value="Submit" />
						</strong>
					</li>
				</ol>
			</li>

		</ol>

	</form>


</div>


<script src="qunit-helpers.js"></script>

<script><!-- //

	module( 'environment' );

	test( 'test fields are in test form', 25, function() {

		strictEqual( $( 'form#test' ).length, 1, 'form#test is present' );
		strictEqual( $( 'form#test input#foo' ).length, 1, 'form#test contains input#foo' );
		strictEqual( $( 'form#test label[for=foo] .alert' ).length, 1, 'input#foo label contains .alert' );
		strictEqual( $( 'form#test input#bar' ).length, 1, 'form#test contains input#bar' );
		strictEqual( $( 'form#test label[for=bar] .alert' ).length, 0, 'input#bar label does not contain .alert' );
		strictEqual( $( 'form#test input#email' ).length, 1, 'form#test contains input#email' );
		strictEqual( $( 'form#test label[for=email] .alert' ).length, 1, 'input#foo label contains .alert' );
		strictEqual( $( 'form#test :radio[name=radioFoo]' ).length, 2, 'form#test contains 2 radio buttons in radioFoo group' );
		strictEqual( $( 'form#test :radio[name=radioFoo]' ).closest( 'fieldset' ).find( 'legend > .alert' ).length, 1, 'radioFoo group legend contains .alert' );

		strictEqual( $( 'form#test #name-group input#name-title' ).length, 1, 'form#test contains #name-group input#name-title' );
		strictEqual( $( 'form#test #name-group input#name-given' ).length, 1, 'form#test contains #name-group input#name-given' );
		strictEqual( $( 'form#test #name-group input#name-family' ).length, 1, 'form#test contains #name-group input#name-family' );
		ok( $( '#name-group' ).parent().hasClass( 'group' ), '#name-group is a group' );
		ok( $( '#name-group' ).parent().hasClass( 'atomic' ), '#name-group is an atomic group' );

		strictEqual( $( 'form#test #dob input#dob-date' ).length, 1, 'form#test contains #dob input#dob-date' );
		strictEqual( $( 'form#test #dob select#dob-month' ).length, 1, 'form#test contains #dob select#dob-month' );
		strictEqual( $( 'form#test #dob input#dob-year' ).length, 1, 'form#test contains #dob input#dob-year' );
		ok( $( '#dob' ).parent().hasClass( 'group' ), '#dob is a group' );
		ok( $( '#dob' ).parent().hasClass( 'atomic' ), '#dob is an atomic group' );

		strictEqual( $( 'input#country', '#postal-address' ).length, 1, '#postal-address contains .group input#country' );
		ok( $( '#postal-address' ).parent().hasClass( 'group' ), '#postal-address is a group' );
		ok( $( '#postal-address' ).parent().hasClass( 'atomic' ), '#postal-address is an atomic group' );
		strictEqual( $( '.group', '#postal-address' ).length, 1, '#postal-address contains one nested .group' );
		strictEqual( $( '.atomic', '#postal-address' ).length, 0, '#postal-address contains no nested atomic groups' );
		strictEqual( $( '.group input#city', '#postal-address' ).length, 1, '#postal-address contains nested .group input#city' );
	});


	module( 'inline validation messages (alerts)' );

	test( 'can get alert value', 6, function() {

		strictEqual( $( '#foo' ).forcesForms( 'alert' )[ 0 ], $( 'label[for=foo] > .alert' )[ 0 ], 'found alert' );
		strictEqual( $( '#foo' ).forcesForms( 'alert' ).text(), 'Must be completed', 'found expected alert text' );

		strictEqual( $( ':radio[name=radioFoo]' ).eq( 0 ).forcesForms( 'alert' )[ 0 ], $( 'legend > .alert' )[ 0 ], 'found alert for radio group' );
		strictEqual( $( ':radio[name=radioFoo]' ).eq( 0 ).forcesForms( 'alert' ).text(), 'Must be completed', 'found expected alert text for radio group' );
		strictEqual( $( ':radio[name=radioFoo]' ).eq( 1 ).forcesForms( 'alert' )[ 0 ], $( 'legend > .alert' )[ 0 ], 'found alert for 2nd radio button' );
		strictEqual( $( ':radio[name=radioFoo]' ).eq( 1 ).forcesForms( 'alert' )[ 0 ], $( ':radio[name=radioFoo]' ).eq( 0 ).forcesForms( 'alert' )[ 0 ], 'Must be completed', 'same alert used for both radio buttons' );

	});

	test( 'can get group alert for atomic group', 3, function() {
		
		strictEqual( $( '#name-given' ).forcesForms( 'alert' )[ 0 ], $( '#name-group > legend > .alert' )[ 0 ], 'found alert' );
		strictEqual( $( '#name-family' ).forcesForms( 'alert' )[ 0 ], $( '#name-group > legend > .alert' )[ 0 ], 'found alert' );
		strictEqual( $( '#name-given' ).forcesForms( 'alert' ).text(), 'Must be completed', 'found expected alert text' );

	});


	module( 'inline validation messages (alerts)', lifecycleCVAPI );

	test( 'alert managed for atomic groups onchange', 7, function() {
		
		// set custom error
		$( '#dob-date' ).val( '56' ).each(function() { this.setCustomValidity( 'Date must be a number (1–31)' ); }).trigger( 'change' );
		strictEqual( $( '#dob' ).closest( '.atomic' ).find( '.alert' ).length, 1, '#dob contains 1 alert' );
		strictEqual( $( '#dob' ).closest( '.atomic' ).find( '.alert' ).text(), 'Date must be a number (1–31)', '#dob alert text is correct' );

		$( '#dob-year' ).val( 'YYYY' ).each(function() { this.setCustomValidity( 'Year must be a 4-digit number' ); }).trigger( 'change' );
		strictEqual( $( '#dob' ).closest( '.atomic' ).find( '.alert' ).length, 1, '#dob contains 1 alert' );
		strictEqual( $( '#dob' ).closest( '.atomic' ).find( '.alert' ).text(), 'Year must be a 4-digit number', '#dob alert text updated to most recent error' );

		// correct 1 of the errors
		$( '#dob-year' ).val( '1976' ).each(function() { this.setCustomValidity( '' ); }).trigger( 'change' );
		strictEqual( $( '#dob' ).closest( '.atomic' ).find( '.alert' ).length, 1, '#dob contains 1 alert' );
		strictEqual( $( '#dob' ).closest( '.atomic' ).find( '.alert' ).text(), 'Date must be a number (1–31)', '#dob alert text is updated to first error within group' );

		// correct all errors
		$( '#dob-date' ).val( '11' ).each(function() { this.setCustomValidity( '' ); }).trigger( 'change' );
		$( '#dob-month' ).each(function() { this.selectedIndex = 8; }).trigger( 'change' );
		strictEqual( $( '#dob' ).closest( '.atomic' ).find( '.alert' ).length, 0, '#dob contains no alerts' );

	});

	test( 'alert managed for mixed groups onchange', 11, function() {
		
		// make state and country valid for this test
		$( '#state, #country' ).val( 'foo' ).trigger( 'change' );

		// set different custom error in nested group
		$( '#city' ).val( 'foo' ).each(function() { this.setCustomValidity( 'Foo is not a city' ); }).trigger( 'change' );
		strictEqual( $( '#postal-address' ).closest( '.atomic' ).find( '.alert' ).length, 1, '#postal-address contains 1 alert' );
		strictEqual( $( '#postal-address' ).closest( '.atomic' ).find( '.alert' ).text(), 'Foo is not a city', '#postal-address alert text is correct' );

		// set different custom error in nested group
		$( '#postcode' ).val( 'foo' ).each(function() { this.setCustomValidity( 'Must be a number' ); }).trigger( 'change' );
		strictEqual( $( '#postal-address' ).closest( '.atomic' ).find( '.alert' ).length, 1, '#postal-address still contains 1 alert' );
		strictEqual( $( '#postal-address' ).closest( '.atomic' ).find( '.alert' ).text(), 'Must be a number', '#postal-address alert text is updated' );

		// set different custom outside nested group
		$( '#street-address' ).val( 'foo' ).each(function() { this.setCustomValidity( 'Must be a street or post office box' ); }).trigger( 'change' );
		strictEqual( $( '#postal-address' ).closest( '.atomic' ).find( '.alert' ).length, 1, '#postal-address still contains 1 alert' );
		strictEqual( $( '#postal-address' ).closest( '.atomic' ).find( '.alert' ).text(), 'Must be a street or post office box', '#postal-address alert text is updated' );

		// fix error inside nested group
		$( '#postcode' ).val( '4000' ).each(function() { this.setCustomValidity( '' ); }).trigger( 'change' );
		strictEqual( $( '#postal-address' ).closest( '.atomic' ).find( '.alert' ).length, 1, '#postal-address still contains 1 alert' );
		strictEqual( $( '#postal-address' ).closest( '.atomic' ).find( '.alert' ).text(), 'Must be a street or post office box', '#postal-address alert text has not changed' );

		// fix error outside nested group
		$( '#street-address' ).val( '1 Roma Street' ).each(function() { this.setCustomValidity( '' ); }).trigger( 'change' );
		strictEqual( $( '#postal-address' ).closest( '.atomic' ).find( '.alert' ).length, 1, '#postal-address still contains 1 alert' );
		strictEqual( $( '#postal-address' ).closest( '.atomic' ).find( '.alert' ).text(), 'Foo is not a city', '#postal-address alert text changed to last error remaining' );

		// fix remaining error inside nested group
		$( '#city' ).val( 'Brisbane' ).each(function() { this.setCustomValidity( '' ); }).trigger( 'change' );
		strictEqual( $( '#postal-address' ).closest( '.atomic' ).find( '.alert' ).length, 0, '#postal-address contains no alerts' );
	});


// --></script>


</body>
</html>
